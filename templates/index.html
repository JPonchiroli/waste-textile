<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Waste Textile</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="font-[Poppins]">

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="fixed top-4 right-4 bg-red-500 text-white p-4 rounded shadow-lg max-w-xs z-50">
        {% for message in messages %}
        <p>{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <main>
        <article id="step-upload" class="grid place-items-center h-screen">
            <form action="/upload" method="POST" enctype="multipart/form-data" class="w-full">
                <div class="flex bg-[#DBEFF7] rounded-2xl w-[880px] h-[520px] overflow-hidden shadow-lg mx-auto">

                    <input type="file" name="arquivo" id="file-input" class="hidden" accept=".xlsx,.csv">

                    <div id="drop-zone"
                        class="w-1/3 bg-[#0A1C36] flex flex-col justify-center items-center p-8 text-center cursor-pointer transition-all duration-300">
                        <h1 class="uppercase text-[#70BFFF] font-bold text-3xl mb-6">Selecione Seu Arquivo</h1>
                        <button type="button" id="browse-btn"
                            class="flex items-center justify-center bg-[#F0F8FF] font-semibold py-3 px-6 rounded-2xl w-[220px] h-[70px] hover:bg-gray-300 transition">
                            <img src="{{ url_for('static', filename='upload-na-nuvem.png') }}" alt="Upload na nuvem"
                                class="w-10 h-10">
                        </button>
                    </div>

                    <div class="w-2/3 bg-[#DBEFF7] p-8 flex flex-col items-center">
                        <div class="text-center mt-[60px]">
                            <h1 class="font-extrabold text-3xl">Waste Textile</h1>
                            <h2 class="font-medium text-base text-gray-700 mt-2">Preencha o Formulário</h2>
                        </div>

                        <input name="nome"
                            class="bg-[#DFE1ED] rounded-2xl w-[480px] h-[60px] shadow-inner pl-5 placeholder:text-gray-400 placeholder:font-bold mt-[120px]"
                            id="file-name" type="text" placeholder="Nenhum arquivo selecionado" disabled>

                        <p id="error-msg" class="text-red-500 text-sm mt-2 hidden">Selecione um arquivo antes de
                            continuar.</p>

                        <button id="btn-submit" type="button"
                            class="flex items-center justify-center text-white font-bold text-xl w-[200px] h-[60px] rounded-full bg-gray-400 uppercase mt-[56px] cursor-not-allowed"
                            disabled>
                            Cadastrar
                        </button>
                    </div>
                </div>
            </form>
        </article>

        <article id="step-processing" class="hidden grid place-items-center h-screen bg-gray-50">
            <div
                class="flex justify-center flex-col items-center bg-white rounded-2xl w-[880px] h-[520px] p-8 shadow-lg">
                <div class="flex items-center">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Processando seu arquivo...</h1>
                    <div
                        class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin ml-5 mb-8">
                    </div>
                </div>
                <p class="text-gray-600">Aguarde, isso pode levar alguns segundos.</p>
            </div>
        </article>

        <article id="step-complete"
            class="hidden flex flex-col justify-center items-center min-h-screen bg-gray-50 py-12">
            <div class="flex flex-col items-center bg-white rounded-2xl p-8 shadow-lg w-full max-w-screen-xl">
                <div class="flex items-center gap-3 mb-4">
                    <h1 class="text-3xl font-bold text-gray-800">Upload Concluído!</h1>
                    <svg class="w-16 h-16 text-green-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <p class="text-gray-600 mb-8">Seu arquivo foi processado. Veja os gráficos abaixo e faça o download
                    dos dados.</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full mb-8">
                    <div class="bg-gray-100 p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-center mb-2">Gráfico 1</h3>
                        <img id="chart1" src="" alt="Gráfico 1" class="w-full h-auto rounded">
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-center mb-2">Gráfico 2</h3>
                        <img id="chart2" src="" alt="Gráfico 2" class="w-full h-auto rounded">
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-center mb-2">Gráfico 3</h3>
                        <img id="chart3" src="" alt="Gráfico 3" class="w-full h-auto rounded">
                    </div>
                </div>

                <a id="download-link" href="#"
                    class="inline-flex items-center bg-blue-600 text-white font-semibold px-6 py-3 rounded-full hover:bg-blue-700 transition shadow-xl"
                    download>
                    Baixar Arquivo Processado (.csv)
                </a>
            </div>
        </article>
    </main>

    <div id="session-data" data-csv-file="{{ session.get('last_processed_file', '') }}"
        data-fig1="{{ session.get('fig1', '') }}" data-fig2="{{ session.get('fig2', '') }}"
        data-fig3="{{ session.get('fig3', '') }}">
    </div>


    <script>
        // DOM Elements
        const stepUpload = document.getElementById('step-upload');
        const stepProcessing = document.getElementById('step-processing');
        const stepComplete = document.getElementById('step-complete');

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const fileNameDisplay = document.getElementById('file-name');
        const submitBtn = document.getElementById('btn-submit');
        const errorMsg = document.getElementById('error-msg');

        // Switch screens
        function showStep(step) {
            stepUpload.classList.add('hidden');
            stepProcessing.classList.add('hidden');
            stepComplete.classList.add('hidden');
            step.classList.remove('hidden');
        }

        function updateFileNameAndButton(file) {
            if (file) {
                fileNameDisplay.value = file.name;
                submitBtn.disabled = false;
                submitBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
                submitBtn.classList.add("bg-[#284CFF]", "hover:bg-blue-500");
                errorMsg.classList.add("hidden");
            } else {
                fileNameDisplay.value = "Nenhum arquivo selecionado";
                submitBtn.disabled = true;
                submitBtn.classList.add("bg-gray-400", "cursor-not-allowed");
                submitBtn.classList.remove("bg-[#284CFF]", "hover:bg-blue-500");
            }
        }

        // File selection logic
        fileInput.addEventListener('change', () => {
            updateFileNameAndButton(fileInput.files.length > 0 ? fileInput.files[0] : null);
        });

        // Submit button click
        submitBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (fileInput.files.length === 0) {
                errorMsg.classList.remove("hidden");
                return;
            }
            showStep(stepProcessing);
            const form = document.querySelector('form');
            form.submit();
        });

        // Browse button click
        browseBtn.addEventListener('click', () => fileInput.click());

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-blue-900'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('bg-blue-900'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-blue-900');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                updateFileNameAndButton(fileInput.files[0]);
            }
        });

        window.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const uploadSuccess = urlParams.get('upload');
            updateFileNameAndButton(null);
            fileInput.value = "";

            if (uploadSuccess === 'success') {
                history.replaceState(null, '', window.location.pathname);

                // --- LÓGICA PARA PEGAR OS DADOS ---
                const sessionData = document.getElementById('session-data').dataset;
                const sessionCsvFile = sessionData.csvFile;
                const fig1_name = sessionData.fig1;
                const fig2_name = sessionData.fig2;
                const fig3_name = sessionData.fig3;

                showStep(stepComplete);

                // Configura link de download
                const downloadLink = document.getElementById('download-link');
                if (downloadLink && sessionCsvFile) {
                    downloadLink.href = `/download/${encodeURIComponent(sessionCsvFile)}`;
                }

                // Configura os gráficos
                const chart1 = document.getElementById('chart1');
                const chart2 = document.getElementById('chart2');
                const chart3 = document.getElementById('chart3');

                if (chart1 && fig1_name) chart1.src = `/plots/${encodeURIComponent(fig1_name)}`;
                if (chart2 && fig2_name) chart2.src = `/plots/${encodeURIComponent(fig2_name)}`;
                if (chart3 && fig3_name) chart3.src = `/plots/${encodeURIComponent(fig3_name)}`;

            } else {
                showStep(stepUpload);
            }
        });
    </script>
</body>

</html>